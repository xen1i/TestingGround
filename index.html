<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Racetrack Hittest</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="/style.css" />

    <!-- IMPORTANT: PLACE YOUR SDK SCRIPT TAG BELOW IF FORKING  -->

    <script src="https://launchar.app/sdk/v1?key=PgCkcRz0dyNiU3cWrOBw3PIB7cFYnuu8&redirect=true"></script>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>

    <script>
      // Define a few custom components useful for AR mode. While these are somewhat reusable,
      // I recommend checking if there are officially supported alternatives before copying
      // these into new projects.

      // See also https://github.com/aframevr/aframe/pull/4356
      AFRAME.registerComponent("hide-in-ar-mode", {
        // Set this object invisible while in AR mode.
        init: function () {
          this.el.sceneEl.addEventListener("enter-vr", (ev) => {
            this.wasVisible = this.el.getAttribute("visible");
            if (this.el.sceneEl.is("ar-mode")) {
              this.el.setAttribute("visible", false);
            }
          });
          this.el.sceneEl.addEventListener("exit-vr", (ev) => {
            if (this.wasVisible) this.el.setAttribute("visible", true);
          });
        },
      });

      AFRAME.registerComponent("ar-shadows", {
        // Swap an object's material to a transparent shadows-only material while
        // in AR mode. Intended for use with a ground plane. The object is also
        // set visible while in AR mode, this is useful if it's hidden in other
        // modes due to them using a 3D environment.
        schema: {
          opacity: { default: 0.3 },
        },
        init: function () {
          this.el.sceneEl.addEventListener("enter-vr", (ev) => {
            this.wasVisible = this.el.getAttribute("visible");
            if (this.el.sceneEl.is("ar-mode")) {
              this.savedMaterial = this.el.object3D.children[0].material;
              this.el.object3D.children[0].material =
                new THREE.ShadowMaterial();
              this.el.object3D.children[0].material.opacity = this.data.opacity;
              this.el.setAttribute("visible", true);
            }
          });
          this.el.sceneEl.addEventListener("exit-vr", (ev) => {
            if (this.savedMaterial) {
              this.el.object3D.children[0].material = this.savedMaterial;
              this.savedMaterial = null;
            }
            if (!this.wasVisible) this.el.setAttribute("visible", false);
          });
        },
      });
    </script>
  </head>
  <body>
    <a-scene
      device-orientation-permission-ui="enabled: false"
      webxr="requiredFeatures:hit-test,local-floor;referenceSpaceType:local-floor"
    >
      <a-assets timeout="30000">
        <!-- Model source: NASA -->
        <a-asset-item
          id="rover"
          src="https://cdn.glitch.global/3e1642bd-4578-49d6-890b-eb456e36ef26/marsrover.glb?v=1686714169557"
          response-type="arraybuffer"
        ></a-asset-item>
        <img id="racetrack" src="canvas.png">
      </a-assets>


      <a-camera position="0 1.2 6"></a-camera>
      <a-ring
        id="reticle"
        ar-hit-test-simple
        rotation="-90 0 0"
        radius-inner="0.02"
        radius-outer="0.03"
      >
        <a-ring color="yellow" radius-inner="0.04" radius-outer="0.05" animation="property: scale; from: 1 1 1; to: 2 2 2; loop: true; dir: alternate"></a-ring>
        <a-ring color="yellow" radius-inner="0.06" radius-outer="0.07" animation="property: scale; from: 1 1 1; to: 3 3 3; loop: true; dir: alternate"></a-ring>
      </a-ring>
      <!-- Environment for 2D and VR viewing. It's auto-hidden in AR mode. -->
      <a-entity
        environment="lighting: none; shadow: none; lightPosition: 0 2.15 0"
        hide-in-ar-mode
      ></a-entity>

      <a-entity id="model" position="-1 0 -3" scale="0.25 0.25 0.25" rotation="0 0 0">
        <a-entity
          position="30 0 0"
          rotation="0 0 0"
          gltf-model="#rover"
          animation-mixer
          shadow="cast: true; receive: false"
        ></a-entity>
      </a-entity>
      <a-plane  id="RT" src="#racetrack" height="5" width="5" position="0 0.01 0" rotation="-90 0 0"></a-plane>
      <a-entity light="type: ambient; intensity: 0.5;"></a-entity>
      <a-light
        type="directional"
        light="castShadow: true;
                      shadowMapHeight: 1024;
                      shadowMapWidth: 1024;
                      shadowCameraLeft: -7;
                      shadowCameraRight: 5;
                      shadowCameraBottom: -5;
                      shadowCameraTop: 5;"
        id="light"
        target="model"
        position="-5 3 1.5"
      ></a-light>

      <!-- This shadow-receiving plane is only visible in AR mode. -->
      <a-plane
        height="15"
        width="15"
        position="0 0 0"
        rotation="-90 0 0"
        shadow="receive: true"
        ar-shadows="opacity: 0.3"
        visible="false"
      ></a-plane>
    </a-scene>

    <div id="text">
      <h1>A-Frame `ar-hit-test-simple` with Ring Reticle</h1>
      <p>
        Size: <button id="btn_full">Full</button>
        <button id="btn_half">1/2</button>
        <button id="btn_quarter">1/4</button>
                <button id="btn_tenth">1/10</button>

      </p>

      <p>
        This requires browser support for immersive-ar WebXR, e.g. an
        <a href="https://developers.google.com/ar/discover/supported-devices"
          >ARCore-compatible</a
        >
        Android or an iOS device using
        <a href="https://launch.variant3d.com/">Variant Launch</a>
      </p>

      <p>
        Paste this Glitch's preview URL into your Variant Launch Code generator
        to get a url that works on Android or iOS.
      </p>
    </div>
    <script>
      function setSize(scale) {
        document
          .getElementById("model")
          .setAttribute("scale", { x: scale, y: scale, z: scale });
      }
      document.getElementById("btn_full").onclick = setSize.bind(this, 1);
      document.getElementById("btn_half").onclick = setSize.bind(this, 0.5);
      document.getElementById("btn_quarter").onclick = setSize.bind(this, 0.25);
      document.getElementById('btn_tenth').onclick = setSize.bind(this, 0.1);

    </script>
    <script>
      <!-- https://github.com/stspanho/aframe-hit-test/blob/master/index.html -->
      AFRAME.registerComponent("ar-hit-test-simple", {
        init: function () {
          this.xrHitTestSource = null;
          this.viewerSpace = null;
          this.refSpace = null;

          this.el.sceneEl.renderer.xr.addEventListener("sessionend", (ev) => {
            this.viewerSpace = null;
            this.refSpace = null;
            this.xrHitTestSource = null;
          });
          this.el.sceneEl.renderer.xr.addEventListener("sessionstart", (ev) => {
            let session = this.el.sceneEl.renderer.xr.getSession();

            let element = this.el;
            					session.addEventListener('select', function () {
            						let position = element.getAttribute('position');
            						document.getElementById('RT').setAttribute('position', position);
            					});

            session.requestReferenceSpace("viewer").then((space) => {
              this.viewerSpace = space;
              session
                .requestHitTestSource({ space: this.viewerSpace })
                .then((hitTestSource) => {
                  this.xrHitTestSource = hitTestSource;
                });
            });

            session.requestReferenceSpace("local-floor").then((space) => {
              this.refSpace = space;
            });
          });
        },
        tick: function () {
          if (!this.viewerSpace) return;

          let frame = this.el.sceneEl.frame;
          let xrViewerPose = frame.getViewerPose(this.refSpace);

          if (this.xrHitTestSource && xrViewerPose) {
            let hitTestResults = frame.getHitTestResults(this.xrHitTestSource);
            if (hitTestResults.length > 0) {
              let pose = hitTestResults[0].getPose(this.refSpace);

              let inputMat = new THREE.Matrix4();
              inputMat.fromArray(pose.transform.matrix);

              let position = new THREE.Vector3();
              position.setFromMatrixPosition(inputMat);
              this.el.setAttribute("position", position);
            }
          }
        },
      });
    </script>
  </body>
</html>
